-- Ejercicio A

--“NOTA: SE DEJA COMO CODIGO DE ENFERMEDAD 123 YA QUE NO SE SABE CUAL PERTENECE A COVID”

SELECT 
TE.NOMBRE_EMPRESA,
TT.NOMBRE_TRABAJADOR,
COUNT(TLM.ID_LICENCIA_MEDICA) AS 'CANTIDAD DE LICENCIAS'

		

FROM TBL_TRABAJADOR TT
INNER JOIN REL_TRABAJADOR_EMPRESA TTE
ON TT.ID_TRABAJADOR = TTE.ID_TRABAJADOR
INNER JOIN TBL_EMPRESA TE
ON TTE.ID_EMPRESA = TE.ID_EMPRESA
INNER JOIN TBL_LICENCIA_MEDICA TLM
ON TTE.ID_TRABAJADOR_EMPRESA = TLM.ID_TRABAJADOR_EMPRESA
WHERE 
TLM.CODIGO_ENFERMEDAD = 123 AND year(TTE.FECHA_FIN_CONTRATO) = 9999 AND DATEDIFF(DAY,FECHA_INICIO,FECHA_FIN) < 15
GROUP BY 
TE.NOMBRE_EMPRESA,
TT.NOMBRE_TRABAJADOR,
TLM.CODIGO_ENFERMEDAD

-- Ejercicio B

SELECT 
TE.RUT_EMPRESA,
TE.NOMBRE_EMPRESA

FROM REL_TRABAJADOR_EMPRESA TTE
INNER JOIN TBL_EMPRESA TE
ON TTE.ID_EMPRESA = TE.ID_EMPRESA
INNER JOIN TBL_LICENCIA_MEDICA TLM
ON TTE.ID_TRABAJADOR_EMPRESA = TLM.ID_TRABAJADOR_EMPRESA
WHERE 
year(TTE.FECHA_FIN_CONTRATO) != 9999 AND DATEDIFF(DAY,FECHA_INICIO,FECHA_FIN) < 15
GROUP BY
TE.RUT_EMPRESA,
TE.NOMBRE_EMPRESA


-- Ejercicio C

SELECT DISTINCT
TE.NOMBRE_EMPRESA
,YEAR(TLM.FECHA_INICIO) AS 'AÑO'
,COUNT(TLM.ID_LICENCIA_MEDICA) AS 'CANTIDAD LICENCIAS'
,SUM(TLM.MONTO_REEMBOLSO) AS 'MONTO REEMBOLSADO'

FROM TBL_LICENCIA_MEDICA TLM
INNER JOIN REL_TRABAJADOR_EMPRESA TTE
ON TLM.ID_TRABAJADOR_EMPRESA = TTE.ID_TRABAJADOR_EMPRESA
INNER JOIN TBL_EMPRESA TE
ON TTE.ID_EMPRESA = TE.ID_EMPRESA 

WHERE YEAR(TLM.FECHA_INICIO) >= 2015 AND DATEDIFF(DAY,FECHA_INICIO,FECHA_FIN) < 15
GROUP BY YEAR(TLM.FECHA_INICIO),TTE.ID_EMPRESA,TE.NOMBRE_EMPRESA

-- Ejercicio D

--“NOTA: Tabla LICENCIA MEDICA se indicaría mejor con un campo para saber si es licencia continua”

SELECT 
TT.ID_TRABAJADOR,
TT.RUT_TRABAJADOR,
TT.NOMBRE_TRABAJADOR,
COUNT(TLM.ID_LICENCIA_MEDICA) AS 'CANTIDAD LICENCIAS'

FROM TBL_TRABAJADOR TT
INNER JOIN REL_TRABAJADOR_EMPRESA TTE
ON TT.ID_TRABAJADOR = TTE.ID_TRABAJADOR
INNER JOIN TBL_LICENCIA_MEDICA TLM
ON TTE.ID_TRABAJADOR_EMPRESA = TLM.ID_TRABAJADOR_EMPRESA

WHERE year(TTE.FECHA_FIN_CONTRATO) = 9999 AND  TT.ID_TRABAJADOR IN (6,9)

GROUP BY 
TT.ID_TRABAJADOR,
TT.RUT_TRABAJADOR,
TT.NOMBRE_TRABAJADOR

-- Ejercicio E

SELECT 
TE.RUT_EMPRESA,
TE.NOMBRE_EMPRESA,
AVG(CONVERT(INT,TMD.VALUE)) AS 'PROMEDIO DE RENTAS'


FROM DB_lh_lstuding.dbo.REL_TRABAJADOR_EMPRESA TTE
INNER JOIN DB_lh_lstuding.dbo.TBL_EMPRESA TE
ON TTE.ID_EMPRESA = TE.ID_EMPRESA
INNER JOIN DBO.TBL_LICENCIA_MEDICA TLM
ON TTE.ID_TRABAJADOR_EMPRESA = TLM.ID_TRABAJADOR_EMPRESA
INNER JOIN DBO.TBL_METADATOS TMD
ON TLM.ID_LICENCIA_MEDICA = TMD.ID_LICENCIA_MEDICA
 
GROUP BY TE.RUT_EMPRESA,TE.NOMBRE_EMPRESA


-- Ejercicio F

SELECT TOP 3
TE.NOMBRE_EMPRESA
,TT.RUT_TRABAJADOR
,TT.NOMBRE_TRABAJADOR
,TLM.MONTO_REEMBOLSO AS 'MONTO REEMBOLSADO'
,ROW_NUMBER() OVER(ORDER BY SUM(TLM.MONTO_REEMBOLSO) DESC) AS 'POSICION'

FROM TBL_EMPRESA TE
INNER JOIN REL_TRABAJADOR_EMPRESA TTE
ON TE.ID_EMPRESA = TTE.ID_EMPRESA 
INNER JOIN TBL_TRABAJADOR TT 
ON TTE.ID_TRABAJADOR = TT.ID_TRABAJADOR
INNER JOIN TBL_LICENCIA_MEDICA TLM
ON TTE.ID_TRABAJADOR_EMPRESA = TLM.ID_TRABAJADOR_EMPRESA 

WHERE TE.NOMBRE_EMPRESA LIKE '%UNO%'

GROUP BY
TE.NOMBRE_EMPRESA
,TT.RUT_TRABAJADOR
,TT.NOMBRE_TRABAJADOR
,TLM.MONTO_REEMBOLSO

UNION

SELECT TOP 3
TE.NOMBRE_EMPRESA
,TT.RUT_TRABAJADOR
,TT.NOMBRE_TRABAJADOR
,TLM.MONTO_REEMBOLSO AS 'MONTO REEMBOLSADO'
,ROW_NUMBER() OVER(ORDER BY SUM(TLM.MONTO_REEMBOLSO) DESC) AS 'POSICION'

FROM TBL_EMPRESA TE
INNER JOIN REL_TRABAJADOR_EMPRESA TTE
ON TE.ID_EMPRESA = TTE.ID_EMPRESA 
INNER JOIN TBL_TRABAJADOR TT 
ON TTE.ID_TRABAJADOR = TT.ID_TRABAJADOR
INNER JOIN TBL_LICENCIA_MEDICA TLM
ON TTE.ID_TRABAJADOR_EMPRESA = TLM.ID_TRABAJADOR_EMPRESA 

WHERE TE.NOMBRE_EMPRESA LIKE '%DOS%'

GROUP BY
TE.NOMBRE_EMPRESA
,TT.RUT_TRABAJADOR
,TT.NOMBRE_TRABAJADOR
,TLM.MONTO_REEMBOLSO

UNION

SELECT TOP 3
TE.NOMBRE_EMPRESA
,TT.RUT_TRABAJADOR
,TT.NOMBRE_TRABAJADOR
,TLM.MONTO_REEMBOLSO AS 'MONTO REEMBOLSADO'
,ROW_NUMBER() OVER(ORDER BY SUM(TLM.MONTO_REEMBOLSO) DESC) AS 'POSICION'

FROM TBL_EMPRESA TE
INNER JOIN REL_TRABAJADOR_EMPRESA TTE
ON TE.ID_EMPRESA = TTE.ID_EMPRESA 
INNER JOIN TBL_TRABAJADOR TT 
ON TTE.ID_TRABAJADOR = TT.ID_TRABAJADOR
INNER JOIN TBL_LICENCIA_MEDICA TLM
ON TTE.ID_TRABAJADOR_EMPRESA = TLM.ID_TRABAJADOR_EMPRESA 

WHERE TE.NOMBRE_EMPRESA LIKE '%TRES%'

GROUP BY
TE.NOMBRE_EMPRESA
,TT.RUT_TRABAJADOR
,TT.NOMBRE_TRABAJADOR
,TLM.MONTO_REEMBOLSO

UNION

SELECT TOP 3
TE.NOMBRE_EMPRESA
,TT.RUT_TRABAJADOR
,TT.NOMBRE_TRABAJADOR
,TLM.MONTO_REEMBOLSO AS 'MONTO REEMBOLSADO'
,ROW_NUMBER() OVER(ORDER BY SUM(TLM.MONTO_REEMBOLSO) DESC) AS 'POSICION'

FROM TBL_EMPRESA TE
INNER JOIN REL_TRABAJADOR_EMPRESA TTE
ON TE.ID_EMPRESA = TTE.ID_EMPRESA 
INNER JOIN TBL_TRABAJADOR TT 
ON TTE.ID_TRABAJADOR = TT.ID_TRABAJADOR
INNER JOIN TBL_LICENCIA_MEDICA TLM
ON TTE.ID_TRABAJADOR_EMPRESA = TLM.ID_TRABAJADOR_EMPRESA 

WHERE TE.NOMBRE_EMPRESA LIKE '%CUATRO%'

GROUP BY
TE.NOMBRE_EMPRESA
,TT.RUT_TRABAJADOR
,TT.NOMBRE_TRABAJADOR
,TLM.MONTO_REEMBOLSO

ORDER BY TE.NOMBRE_EMPRESA, TLM.MONTO_REEMBOLSO DESC

-- Ejercicio G


SELECT

TT.RUT_TRABAJADOR
,TT.NOMBRE_TRABAJADOR
,TLM.MONTO_REEMBOLSO AS 'MONTO REEMBOLSADO'
,TM.VALUE
,TLM.ID_LICENCIA_MEDICA

FROM TBL_TRABAJADOR TT
INNER JOIN REL_TRABAJADOR_EMPRESA TTE
ON TT.ID_TRABAJADOR = TTE.ID_TRABAJADOR
INNER JOIN TBL_LICENCIA_MEDICA TLM
ON TTE.ID_TRABAJADOR_EMPRESA = TLM.ID_TRABAJADOR_EMPRESA
INNER JOIN TBL_METADATOS TM
ON TLM.ID_LICENCIA_MEDICA = TM.ID_LICENCIA_MEDICA 

WHERE TLM.FECHA_FIN > GETDATE() 
